{% extends "admin_base.html" %}
{% set subtitle="Create/edit users. Paginated." %}
{% block content %}
<h2 class="text-base font-medium mb-4">User management</h2>

<div class="grid grid-cols-1 lg:grid-cols-5 gap-4 mb-6">
  <div class="lg:col-span-2 rounded-2xl border border-neutral-200 p-4">
    <h3 class="text-sm font-medium mb-3">Create user</h3>
    <form action="/admin/users/new" method="post" class="space-y-3">
      <div>
        <label class="text-sm font-medium">Username</label>
        <input name="username" class="mt-2 w-full rounded-xl border border-neutral-200 px-3 py-2 text-sm" />
      </div>
      <div>
        <label class="text-sm font-medium">Password</label>
        <input type="password" name="password" class="mt-2 w-full rounded-xl border border-neutral-200 px-3 py-2 text-sm" />
      </div>
      <div class="flex items-center gap-2">
        <input type="checkbox" name="is_admin" value="1" />
        <span class="text-sm text-neutral-700">Admin</span>
      </div>
      <button class="rounded-xl bg-neutral-900 px-4 py-2 text-sm font-medium text-white hover:bg-neutral-800" type="submit">
        Create
      </button>
    </form>
  </div>

  <div class="lg:col-span-3 rounded-2xl border border-neutral-200 p-4">
    <div class="flex flex-wrap items-center justify-between gap-3 mb-3">
      <h3 class="text-sm font-medium">Users</h3>
      <form method="get" class="flex items-center gap-2">
        <label class="text-sm text-neutral-600">Per page</label>
        <select name="per_page" class="rounded-xl border border-neutral-200 px-2 py-2 text-sm" onchange="this.form.submit()">
          {% for opt in [10,20,50] %}
            <option value="{{opt}}" {% if per_page==opt %}selected{% endif %}>{{opt}}</option>
          {% endfor %}
        </select>
        <input type="hidden" name="page" value="1" />
      </form>
    </div>

    <div class="overflow-x-auto">
      <table class="w-full text-sm">
        <thead class="text-neutral-600">
          <tr class="border-b">
            <th class="py-2 text-left">ID</th>
            <th class="py-2 text-left">Username</th>
            <th class="py-2 text-left">Role</th>
            <th class="py-2 text-left">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for u in users %}
          <tr class="border-b">
            <td class="py-2">{{ u.id }}</td>
            <td class="py-2">{{ u.username }}</td>
            <td class="py-2">{{ "admin" if u.is_admin else "user" }}</td>
            <td class="py-2">
              <form action="/admin/users/{{u.id}}/edit" method="post" class="inline-flex items-center gap-2">
                <input name="new_username" value="{{u.username}}" class="rounded-lg border border-neutral-200 px-2 py-1 text-xs w-32"/>
                <select name="is_admin" class="rounded-lg border border-neutral-200 px-2 py-1 text-xs">
                  <option value="0" {% if not u.is_admin %}selected{% endif %}>user</option>
                  <option value="1" {% if u.is_admin %}selected{% endif %}>admin</option>
                </select>
                <button class="rounded-lg border border-neutral-200 px-2 py-1 text-xs hover:bg-neutral-50" type="submit">Save</button>
              </form>

              <form action="/admin/users/{{u.id}}/password" method="post" class="inline-flex items-center gap-2 ml-3">
                <input type="password" name="new_password" placeholder="new password"
                       class="rounded-lg border border-neutral-200 px-2 py-1 text-xs w-36"/>
                <button class="rounded-lg border border-neutral-200 px-2 py-1 text-xs hover:bg-neutral-50" type="submit">Set</button>
              </form>

              <form action="/admin/users/{{u.id}}/delete" method="post" class="inline ml-3"
                    onsubmit="return confirm('Delete user {{u.username}} and all their jobs?');">
                <button class="rounded-lg border border-red-200 bg-red-50 px-2 py-1 text-xs text-red-700 hover:bg-red-100" type="submit">
                  Delete
                </button>
              </form>
            </td>
          </tr>
          {% endfor %}
          {% if users|length == 0 %}
          <tr><td class="py-6 text-neutral-600" colspan="4">No users.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>

    <div class="flex items-center justify-between mt-4 text-sm">
      <div class="text-neutral-600">Total: {{ total }}</div>
      <div class="flex items-center gap-2">
        {% if page > 1 %}
          <a class="rounded-xl border border-neutral-200 px-3 py-1 hover:bg-neutral-50" href="/admin/users?page={{page-1}}&per_page={{per_page}}">Prev</a>
        {% else %}
          <span class="rounded-xl border border-neutral-100 px-3 py-1 text-neutral-400">Prev</span>
        {% endif %}

        <span class="text-neutral-700">Page {{ page }} / {{ total_pages }}</span>

        {% if page < total_pages %}
          <a class="rounded-xl border border-neutral-200 px-3 py-1 hover:bg-neutral-50" href="/admin/users?page={{page+1}}&per_page={{per_page}}">Next</a>
        {% else %}
          <span class="rounded-xl border border-neutral-100 px-3 py-1 text-neutral-400">Next</span>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}
